################################################################################
# Set input states when HA starts or states change
################################################################################

- alias: Set state for livingroom air purifier input
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sensor.xiaomi_miio_device_mode
  action:
    service: input_select.select_option
    data_template:
      entity_id: input_select.airpurifier_livingroom_mode
      option: '{{ states.fan.wohnzimmer_airpurifier.attributes.mode }}'

- alias: Set state for livingroom air purifier favorite level input
  trigger:
    - platform: homeassistant
      event: start
    - platform: state
      entity_id: sensor.xiaomi_miio_device_favorite_level
  action:
    service: input_number.set_value
    data_template:
      entity_id: input_number.airpurifier_livingroom_favorite_level
      value: '{{ states.fan.wohnzimmer_airpurifier.attributes.favorite_level | int }}'

################################################################################
# Inputs
################################################################################

- alias: Livingroom air purifier mode
  trigger:
    platform: state
    entity_id: input_select.airpurifier_livingroom_mode
  action:
    - service: fan.set_speed
      data_template:
        entity_id: fan.wohnzimmer_airpurifier
        speed: '{{ states.input_select.airpurifier_mode.state }}'

- alias: Livingroom air purifier favorite level
  trigger:
    platform: state
    entity_id: input_number.airpurifier_livingroom_favorite_level
  action:
    - service: xiaomi_miio.fan_set_favorite_level
      data_template:
        entity_id: fan.wohnzimmer_airpurifier
        level: '{{ states.input_number.airpurifier_favorite_level.state | int }}'


################################################################################
# Automatic control
################################################################################

- alias: Turn off livingroom airpurifier
  trigger:
    platform: numeric_state
    entity_id: fan.wohnzimmer_airpurifier
    value_template: "{{ states.fan.wohnzimmer_airpurifier.attributes.aqi | int }}"
    below: 50
    for: '00:00:10'
  condition:
    - condition: state
      entity_id: fan.wohnzimmer_airpurifier
      state: 'on'
  action:
    service: fan.turn_off
    entity_id: fan.wohnzimmer_airpurifier

- alias: Turn on livingroom airpurifier
  trigger:
    platform: numeric_state
    entity_id: fan.wohnzimmer_airpurifier
    value_template: "{{ states.fan.wohnzimmer_airpurifier.attributes.aqi | int }}"
    above: 50
    for: '00:00:10'
  condition:
    - condition: state
      entity_id: fan.wohnzimmer_airpurifier
      state: 'off'
  action:
    service: fan.turn_on
    entity_id: fan.wohnzimmer_airpurifier

- alias: Set favorite fan speed for livingroom airpurifier
  trigger:
    platform: time_pattern
    seconds: '/30'
  action:
    - service: fan.set_speed
      entity_id: fan.wohnzimmer_airpurifier
      data:
        speed: favorite
    - service: xiaomi_miio.fan_set_favorite_level
      data_template:
        entity_id: fan.wohnzimmer_airpurifier
        level: >
            {% if states.fan.wohnzimmer_airpurifier.attributes.aqi | int == 600 %}
              12
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 500 %}
              11
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 400 %}
              10
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 350 %}
              8
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 300 %}
              7
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 230 %}
              6
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 150 %}
              5
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 125 %}
              4
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 100 %}
              3
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 75 %}
              2
            {% elif states.fan.wohnzimmer_airpurifier.attributes.aqi | int > 50 %}
              1
            {% else %}
              0
            {% endif %}
    - service: input_select.select_option
      data_template:
        entity_id: input_select.airpurifier_livingroom_mode
        option: '{{ states.fan.wohnzimmer_airpurifier.attributes.mode }}'
    - service: input_number.set_value
      data_template:
        entity_id: input_number.airpurifier_livingroom_favorite_level
        value: '{{ states.fan.wohnzimmer_airpurifier.attributes.favorite_level }}'
